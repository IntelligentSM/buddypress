<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  






  <head>
    <title>
      #51913 (Potential `unsupported operand types` dashboard fatal on PHP8 + multisite + upload space check)
     – WordPress Trac
    </title>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
          <link rel="search" href="/search" />
          <link rel="prev" href="/ticket/51912" title="Ticket #51912" />
          <link rel="last" href="/ticket/51942" title="Ticket #51942" />
          <link rel="help" href="/wiki/TracGuide" />
          <link rel="alternate" href="/ticket/51913?format=csv" type="text/csv" class="csv" title="Comma-delimited Text" />
          <link rel="alternate" href="/ticket/51913?format=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" />
          <link rel="alternate" href="/ticket/51913?format=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
          <link rel="next" href="/ticket/51914" title="Ticket #51914" />
          <link rel="start" href="/wiki" />
	<link rel="stylesheet" href="https://s.w.org/style/trac/common/css/trac.css?v=148" />
	<link rel="stylesheet" href="https://s.w.org/style/trac/common/css/ticket.css?v=148" />
	<link rel="stylesheet" href="https://s.w.org/style/trac/common/css/jquery-ui/jquery-ui.css?v=148" />
	<link rel="stylesheet" href="https://s.w.org/style/trac/common/css/jquery-ui-addons.css?v=148" />
          <link rel="icon" href="/chrome/common/trac.ico" type="image/x-icon" />
          <link rel="first" href="/ticket/1" title="Ticket #1" />
    <style id="trac-noscript" type="text/css">.trac-noscript { display: none !important }</style>
      <link type="application/opensearchdescription+xml" rel="search" href="/search/opensearch" title="Search WordPress Trac" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token=null;
      var jquery_ui={"ampm":true,"date_format":"mm/dd/yy","day_names":{"abbreviated":["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],"narrow":["Su","Mo","Tu","We","Th","Fr","Sa"],"wide":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},"default_timezone":null,"first_week_day":0,"month_names":{"abbreviated":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wide":["January","February","March","April","May","June","July","August","September","October","November","December"]},"period_names":{"am":["AM","AM"],"pm":["PM","PM"]},"show_timezone":false,"time_format":"hh:mm:ss TT","timepicker_separator":" ","timezone_iso8601":false,"timezone_list":null};
      var comments_prefs={"comments_order":"oldest","show_comments":"true","show_prop_changes":"true"};
    </script>
	<link rel="dns-prefetch" href="//s.w.org" />
	<link rel="dns-prefetch" href="//fonts.googleapis.com" />
	<link rel="dns-prefetch" href="//fonts.gstatic.com" />
	<link rel="dns-prefetch" href="//www.googletagmanager.com" />
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
		new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
		j=d.createElement(s);j.async=true;j.src=
		'https://www.googletagmanager.com/gtm.js?id='+i;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-5Z8B3BX');</script>
	<script>
		// <![CDATA[
		window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/s.w.org\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.3-alpha-45769"}};
		!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039]))&&(!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b));case"emoji":return b=d([55357,56424,55356,57342,8205,55358,56605,8205,55357,56424,55356,57340],[55357,56424,55356,57342,8203,55358,56605,8203,55357,56424,55356,57340]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		// ]]>
	</script>
	<style>
		img.emoji {
			display: inline !important;
			border: none !important;
			box-shadow: none !important;
			height: 1em !important;
			width: 1em !important;
			margin: 0 .07em !important;
			vertical-align: -0.1em !important;
			background: none !important;
			padding: 0 !important;
		}
	</style>
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,400,300,600&amp;subset=latin,cyrillic-ext,greek-ext,greek,vietnamese,latin-ext,cyrillic" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="https://s.w.org/style/wp4.css?80" />
	<!--[if lte IE 8]>
	<style type="text/css">
	@import url("https://s.w.org/style/ie.css?1");
	</style>
	<![endif]-->
	<meta name="viewport" content="width=device-width" />
	<link rel="stylesheet" href="https://s.w.org/wp-includes/css/dashicons.min.css?20150710" type="text/css" />
	<link rel="stylesheet" type="text/css" href="https://s.w.org/style/trac/wp-trac.css?148" />
	<script src="https://s.w.org/style/trac/common/js/jquery.js?v=148"></script>
		<link rel="canonical" href="https://core.trac.wordpress.org/ticket/51913" />
	<script src="https://s.w.org/style/trac/common/js/babel.js?v=148"></script>
	<script src="https://s.w.org/style/trac/common/js/trac.js?v=148"></script>
	<script src="https://s.w.org/style/trac/common/js/search.js?v=148"></script>
	<script src="https://s.w.org/style/trac/common/js/folding.js?v=148"></script>
	<script src="https://s.w.org/style/trac/common/js/wikitoolbar.js?v=148"></script>
	<script src="https://s.w.org/style/trac/common/js/resizer.js?v=148"></script>
	<script src="https://s.w.org/style/trac/common/js/auto_preview.js?v=148"></script>
	<script src="https://s.w.org/style/trac/common/js/jquery-ui.js?v=148"></script>
	<script src="https://s.w.org/style/trac/common/js/jquery-ui-addons.js?v=148"></script>
	<script src="https://s.w.org/style/trac/common/js/jquery-ui-i18n.js?v=148"></script>
    <script type="text/javascript">
      jQuery("#trac-noscript").remove();
      jQuery(document).ready(function($) {
        $(".trac-autofocus").focus();
        $(".trac-target-new").attr("target", "_blank");
        if ($.ui) { /* is jquery-ui added? */
          $(".trac-datepicker:not([readonly])").prop("autocomplete", "off").datepicker();
          $(".trac-datetimepicker:not([readonly])").prop("autocomplete", "off").datetimepicker();
          $("#main").addClass("trac-nodatetimehint");
        }
        $(".trac-disable").disableSubmit(".trac-disable-determinant");
        setTimeout(function() { $(".trac-scroll").scrollToTop() }, 1);
        $(".trac-disable-on-submit").disableOnSubmit();
      });
    </script>
	<script src="https://s.w.org/style/trac/common/js/threaded_comments.js?v=148"></script>
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
      /*<![CDATA[*/
        $("#attachments").toggleClass("collapsed");
        $("#trac-up-attachments").click(function () {
          $("#attachments").removeClass("collapsed");
          return true;
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        function setRevertHandler() {
          $("button.trac-revert").click(function() {
            var div = $("div", this);
            var field_name = div[0].id.substr(7);
            var field_value = div.text();
            var input = $("#propertyform *[name=field_" + field_name + "]");
            if (input.length > 0) {
              if (input.filter("input[type=radio]").length > 0) {
                input.val([field_value]);
              } else if (input.filter("input[type=checkbox]").length > 0) {
                input.val(field_value == "1" ? [field_value] : []);
              } else {
                input.val(field_value);
              }
            } else { // Special case for CC checkbox
              input = $("#propertyform input[name=cc_update]").val([]);
            }
            input.change();
            // Remove the revert button
            if ($(this).closest("tbody").children("tr").length === 1)
              $(this).closest(".trac-change-panel").remove();
            else
              $(this).closest("tr").remove();
            return false;
          });
        }
        setRevertHandler();
        var comment_focused = false;
        $("#comment").focus(function() { comment_focused = true; })
                     .blur(function() { comment_focused = false; });
        $("#propertyform").autoSubmit({preview: '1'}, function(data, reply) {
          var items = $(reply);
          // Update ticket box
          $("#ticket").replaceWith(items.filter('#ticket'));
          // Replaces content of #changelog, without recreating it
          $("#changelog").empty().append(items.filter("#changelog").contents());
          // Apply comments order and "Show" preferences
          applyCommentsOrder(
            $('#prefs input[name="trac-comments-order"]:checked').val());
          // Show warning
          var new_changes = $("#changelog .trac-new");
          $("#trac-edit-warning").toggle(new_changes.length != 0);
          if (new_changes.length != 0)
            $("#changelog").parent().show().removeClass("collapsed");
          // Update view time
          $("#propertyform input[name='view_time']").replaceWith(items.filter("input[name='view_time']"));
          // Update preview
          var preview = $("#ticketchange").html(items.filter('#preview').children());
          var show_preview = preview.children().length != 0;
          $("#ticketchange").toggle(show_preview);
          setRevertHandler();
          // Execute scripts to load stylesheets
          items.filter("script").appendTo("head");
        }, "#ticketchange .trac-loading");
        $("#trac-comment-editor").autoSubmit({preview_comment: '1'}, function(data, reply) {
          var comment = $("#trac-comment-editor").next("div.comment").html(reply);
          comment.toggle(comment.children().length != 0);
        }, "#changelog .trac-loading");
        /*]]>*/
      });
    </script>
<link rel="stylesheet" href="https://s.w.org/wp-content/plugins/trac-notifications/make-core.css?ver=5" />
</head>
  <body id="wordpress-org" class="core trac wporg-make make-core">
	<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5Z8B3BX" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<div id="wporg-header">
    <div class="wrapper">
        <h1><a href="https://wordpress.org">WordPress.org</a></h1>
        <div id="head-search">
            <form action="https://wordpress.org/search/do-search.php" method="get">
                <label for="global-search" class="screen-reader-text">Search WordPress.org for:</label>
                <input id="global-search" class="text" name="search" type="text" value="" maxlength="150" placeholder="Search WordPress.org" />
                <button type="submit" class="button"><span class="screen-reader-text">Submit</span></button>
            </form>
        </div>
        <div style="clear:both"></div>
        <button id="mobile-menu-button" aria-expanded="false"><span class="screen-reader-text">Toggle Menu</span></button>
        <ul id="wporg-header-menu">
            <li><a href="https://wordpress.org/showcase/" data-title="See some of the sites built on WordPress.">Showcase</a></li>
            <li><a href="https://wordpress.org/themes/" data-title="Find just the right look for your website.">Themes</a></li>
            <li><a href="https://wordpress.org/plugins/" data-title="Plugins can extend WordPress to do almost anything you can imagine.">Plugins</a>
                <div class="uparrow"></div>
            </li>
            <li><a href="https://wordpress.org/mobile/" data-title="Take your website on the go!">Mobile</a></li>
            <li><a href="https://wordpress.org/support/" data-title="Forums, documentation, help.">Support</a>
                <ul class="nav-submenu">
                    <li><a href="https://wordpress.org/support/" data-title="Documentation, tutorials, best practices.">Documentation</a></li>
                    <li><a href="https://wordpress.org/support/forums/" data-title="Support and discussion forums.">Forums</a></li>
                </ul>
                <div class="uparrow"></div>
            </li>
            <li><a href="https://make.wordpress.org/" data-title="Contribute your knowledge." class="current">Get Involved</a>
                <div class="uparrow"></div>
            </li>
            <li><a href="https://wordpress.org/about/" data-title="About the WordPress Organization, and where we're going.">About</a></li>
            <li><a href="https://wordpress.org/news/" data-title="Come here for the latest scoop.">Blog</a></li>
            <li><a href="https://wordpress.org/hosting/" data-title="Find a home for your blog.">Hosting</a></li>
            <li id="download" class="button download-button"><a href="https://wordpress.org/download/" data-title="Get it. Got it? Good.">Get WordPress</a></li>
        </ul>
        <div style="clear:both"></div>
    </div>
</div>
	<div id="headline">
		<div class="wrapper">
			<h2><a href="https://make.wordpress.org/core/">Make WordPress Core</a></h2>
			<div class="menu-container"><ul class="menu">
				<li><a href="https://make.wordpress.org/core/">Blog</a></li>
				<li><a href="https://make.wordpress.org/core/handbook/">Handbook</a></li>
				<li><a class="open-ticket-report" href="https://make.wordpress.org/core/reports/">Tickets</a></li>
				<li><a href="https://make.wordpress.org/core/components/">Components</a></li>
				<li class="icon browser"><a title="Browse Source" href="https://core.trac.wordpress.org/browser">Browse Source</a></li>
				<li class="icon timeline"><a title="Trac Timeline" href="https://core.trac.wordpress.org/timeline">Trac Timeline</a></li>
				<li class="icon newticket"><a title="Create a New Ticket" href="https://login.wordpress.org/?redirect_to=https://core.trac.wordpress.org/newticket" rel="nofollow">Create a New Ticket</a></li>
			</ul></div>
		</div>
	</div>
    <div id="banner">
      <form id="search" action="/search" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="/login">Login</a></li><li class="last"><a href="https://make.wordpress.org/core/notifications/">Notifications</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
        <ul>
          <li class="first"><span>&larr; <a class="prev" href="/ticket/51912" title="Ticket #51912">Previous Ticket</a></span></li><li class="last"><span><a class="next" href="/ticket/51914" title="Ticket #51914">Next Ticket</a> &rarr;</span></li>
        </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
        <div id="ticket" class="trac-content ">
  <div class="date">
    <p>Opened <a class="timeline" href="/timeline?from=2020-12-02T02%3A01%3A56Z&amp;precision=second" title="See timeline at 12/02/2020 02:01:56 AM">3 days ago</a></p>
    <p>Closed <a class="timeline" href="/timeline?from=2020-12-03T20%3A37%3A44Z&amp;precision=second" title="See timeline at 12/03/2020 08:37:44 PM">23 hours ago</a></p>
    <p>Last modified <a class="timeline" href="/timeline?from=2020-12-03T20%3A51%3A37Z&amp;precision=second" title="See timeline at 12/03/2020 08:51:37 PM">23 hours ago</a></p>
  </div>
  <h2>
    <a href="/ticket/51913" class="trac-id">#51913</a>
    <span class="trac-status">
      <a href="/query?status=closed">closed</a>
    </span>
    <span class="trac-type">
      <a href="/query?status=!closed&amp;type=defect+(bug)">defect (bug)</a>
    </span>
    <span class="trac-resolution">
      (<a href="/query?status=closed&amp;resolution=fixed">fixed</a>)
    </span>
  </h2>
  <h1 id="trac-ticket-title" class="searchable">
    <span class="summary">Potential `unsupported operand types` dashboard fatal on PHP8 + multisite + upload space check</span>
  </h1>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
  <a href="https://profiles.wordpress.org/iandunn" data-nicename="iandunn">
    <img class="avatar" src="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=96 2x" height="48" width="48" />
  </a>
    <a class="trac-author" href="/query?status=!closed&amp;reporter=iandunn">iandunn</a>
</td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
  <a href="https://profiles.wordpress.org/iandunn">
    <img class="avatar" src="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=96 2x" height="48" width="48" />
  </a>
    <a class="trac-author" href="/query?status=!closed&amp;owner=iandunn">iandunn</a>
</td>
    </tr>
    <tr>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="milestone" href="/milestone/5.6" title="No date set">5.6</a>
        </td>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="/query?status=!closed&amp;priority=highest+omg+bbq">highest omg bbq</a>
        </td>
    </tr><tr>
        <th id="h_severity">
          Severity:
        </th>
        <td headers="h_severity">
              <a href="/query?status=!closed&amp;severity=blocker">blocker</a>
        </td>
        <th id="h_version">
          Version:
        </th>
        <td headers="h_version">
              <a href="/query?status=!closed&amp;version=trunk">trunk</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="/query?status=!closed&amp;component=Administration">Administration</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
              <a href="/query?status=!closed&amp;keywords=~php8">php8</a> <a href="/query?status=!closed&amp;keywords=~has-patch">has-patch</a> <a href="/query?status=!closed&amp;keywords=~needs-testing">needs-testing</a>
        </td>
    </tr><tr>
        <th id="h_focuses">
          Focuses:
        </th>
        <td headers="h_focuses">
              <a href="/query?status=!closed&amp;focuses=~administration">administration</a>, <a href="/query?status=!closed&amp;focuses=~multisite">multisite</a>
        </td>
        <th id="h_cc" class="missing">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
After upgrading my local environment to PHP 8, and a test site to the 5.6 branch, I got a fatal error in the <code>At A Glance</code> dashboard widget.<br />
</p>
<pre class="wiki">PHP Fatal error:  Uncaught TypeError: Unsupported operand types: array / int in /Users/iandunn/vhosts/localhost/wordcamp.test/public_html/mu/wp-includes/ms-functions.php:2635
Stack trace:
#0 /Users/iandunn/vhosts/localhost/wordcamp.test/public_html/mu/wp-admin/includes/dashboard.php(1549): get_space_used()
#1 /Users/iandunn/vhosts/localhost/wordcamp.test/public_html/mu/wp-includes/class-wp-hook.php(287): wp_dashboard_quota('')
#2 /Users/iandunn/vhosts/localhost/wordcamp.test/public_html/mu/wp-includes/class-wp-hook.php(311): WP_Hook-&gt;apply_filters('', Array)
#3 /Users/iandunn/vhosts/localhost/wordcamp.test/public_html/mu/wp-includes/plugin.php(484): WP_Hook-&gt;do_action(Array)
#4 /Users/iandunn/vhosts/localhost/wordcamp.test/public_html/mu/wp-admin/includes/dashboard.php(411): do_action('activity_box_en...')
#5 /Users/iandunn/vhosts/localhost/wordcamp.test/public_html/mu/wp-admin/includes/template.php(1389): wp_dashboard_right_now('', Array)
#6 /Users/iandunn/vhosts/localhost/wordcamp.test/public_html/mu/wp-admin/includes/dashboard.php(265): do_meta_boxes(Object(WP_Screen), 'column4', '')
#7 /Users/iandunn/vhosts/localhost/wordcamp.test/public_html/mu/wp-admin/index.php(181): wp_dashboard()
#8 {main}
  thrown in /Users/iandunn/vhosts/localhost/wordcamp.test/public_html/mu/wp-includes/ms-functions.php on line 2635
</pre><p>
This seems related to the caching added in <a class="changeset" href="/changeset/49212" title="Multisite: More specific caching for `get_dirsize`.

Instead of one ...">r49212</a> (<a class="closed ticket" href="/ticket/19879" title="#19879: task (blessed): Better caching for get_dirsize (closed: fixed)">#19879</a>), cc @helen.<br />
</p>
<p>
<code>get_dirsize()</code> and <code>recurse_dirsize()</code> returned an array instead of an int. <code>return $directory_cache[ $cache_path ]</code> was expecting that value to be an int, but instead it was <code>array( 'size' =&gt; 0 )</code>.<br />
</p>
<p>
I don't see how it could be created like this, but the transient value was:<br />
</p>
<pre class="wiki">a:1:{s:94:"/Users/iandunn/vhosts/localhost/wp-develop.test/public_html/build/wp-content/blogs.dir/2/files";a:1:{s:4:"size";i:0;}}
</pre><p>
In PHP7 the arguments of <code>get_dirsize( $upload_dir['basedir'] ) / MB_IN_BYTES</code> would have been silently cast to match types, <a class="ext-link" href="https://wiki.php.net/rfc/arithmetic_operator_type_checks"><span class="icon">​</span>but in PHP8 it's a fatal error</a>.<br />
</p>
<p>
The error is no longer happening on my test site, and <strong>I haven't been able to reproduce it in a fresh install</strong>, so this may be <code>invalid</code>. There doesn't appear to be any 3rd party code related to this behavior, though. Since the 5.6 release date is only a week away, and it's had a relatively small amount of real-world testing w/ PHP 8, I thought it'd be prudent to get some more eyes on this.<br />
</p>
<p>
<code>get_dirsize()</code> is only called in Multisite, but <code>recurse_dirsize()</code> is called by single site, so there may be other instances of a similar problem.<br />
</p>
<hr />
<h2 id="Tryingtoreproduce:">Trying to reproduce:</h2>
<p>
Before I upgraded and got the error, my environment looked like this:<br />
</p>
<ul><li>PHP 7.2
</li><li>WP 5.5 branch via SVN, probably a few weeks behind the head
</li><li>Multisite
</li><li><code>upload_space_check_disabled</code> = <code>0</code> 
</li></ul><p>
I installed PHP 8.0.0, then <code>svn sw ^/branches/5.6</code> (head was <a class="changeset" href="/changeset/49734" title="Post WordPress 5.6 RC 2 version bump.
">r49734</a> at the time of writing this)<br />
</p>
<p>
IIRC, I encountered the error on the main site, which affects the execution path in <code>get_dirsize()</code>.<br />
</p>

    </div>
  </div>
</div>
          

        <div>
          <div class="trac-noscript" style="position: relative">
            <form id="prefs" method="get" action="/prefs" style="position: absolute; right: 0">
              <div id="trac-comments-order">
                <input type="radio" id="trac-comments-oldest" name="trac-comments-order" value="oldest" checked="checked" />
                <label for="trac-comments-oldest">Oldest first</label>
                <input type="radio" id="trac-comments-newest" name="trac-comments-order" value="newest" />
                <label for="trac-comments-newest">Newest first</label>
                <span id="trac-threaded-toggle" style="display: none">
                  <input type="radio" id="trac-comments-threaded" name="trac-comments-order" value="threaded" />
                  <label for="trac-comments-threaded">Threaded</label>
                </span>
              </div>
              <div>
                <input id="trac-show-comments-toggle" type="checkbox" checked="checked" />
                <label for="trac-show-comments-toggle">Show comments</label>
                <input id="trac-show-property-changes-toggle" type="checkbox" />
                <label for="trac-show-property-changes-toggle">Show property changes</label>
              </div>
            </form>
          </div>
          <h3 class="foldable">Change History <span class="trac-count">(21)</span></h3>
          <div id="changelog">
              <div class="change" id="trac-change-1-1606919450306638">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:1" class="cnum">
    <a href="#comment:1">#1</a>
  </span>
    </span>
        <span class="avatar">
          <span class="username-line"><a href="https://profiles.wordpress.org/iandunn" class="profile-link">
            <img src="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=96 2x" height="48" width="48" /> @<span class="username" data-username="iandunn" data-nicename="iandunn"><span class="trac-author">iandunn</span></span></a></span>
            <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-02T14%3A30%3A50Z&amp;precision=second" title="See timeline at 12/02/2020 02:30:50 PM">2 days</a> ago</span>
        </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>
  <div class="trac-ticket-buttons"></div>
  <ul class="changes">
    <li class="trac-field-owner">
      <strong class="trac-field-owner">Owner</strong>
        set to <em>iandunn</em>
    </li><li class="trac-field-priority">
      <strong class="trac-field-priority">Priority</strong>
        changed from <em>high</em> to <em>highest omg bbq</em>
    </li><li class="trac-field-severity">
      <strong class="trac-field-severity">Severity</strong>
        changed from <em>major</em> to <em>blocker</em>
    </li><li class="trac-field-status">
      <strong class="trac-field-status">Status</strong>
        changed from <em>new</em> to <em>accepted</em>
    </li>
  </ul>
    <div class="comment searchable">
      <p>
Ah, I can reproduce this now.<br />
</p>
<p>
It looks like 5.5 set the transient in <code>get_dirsize</code>, and included the <code>size</code> sub-array. When that logic was moved to <code>recurse_dirsize</code>, the <code>size</code> subarray was removed, probably because it seems unnecessary. That caused a conflict between the structure of new and old transients, though.<br />
</p>
<p>
<a href="https://core.trac.wordpress.org/browser/branches/5.5/src/wp-includes/functions.php?rev=49453&amp;marks=7518-7520#L7490">https://core.trac.wordpress.org/browser/branches/5.5/src/wp-includes/functions.php?rev=49453&amp;marks=7518-7520#L7490</a><br />
</p>
<p>
<a href="https://core.trac.wordpress.org/browser/branches/5.6/src/wp-includes/functions.php?rev=49643&amp;marks=7708#L7705">https://core.trac.wordpress.org/browser/branches/5.6/src/wp-includes/functions.php?rev=49643&amp;marks=7708#L7705</a><br />
</p>
<p>
The simplest fix might be to clear the transient during the upgrade. If that won't work, then maybe the 5.6 code should be updated to save the <code>size</code> item? <br />
</p>
<p>
I'll look into those options, but let me know if anyone has any thoughts.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-2-1606920033414309">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:2" class="cnum">
    <a href="#comment:2">#2</a>
  </span>
    </span>
        <span class="avatar">
          <span class="username-line"><a href="https://profiles.wordpress.org/iandunn" class="profile-link">
            <img src="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=96 2x" height="48" width="48" /> @<span class="username" data-username="iandunn" data-nicename="iandunn"><span class="trac-author">iandunn</span></span></a></span>
            <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-02T14%3A40%3A33Z&amp;precision=second" title="See timeline at 12/02/2020 02:40:33 PM">2 days</a> ago</span>
        </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>
  <div class="trac-ticket-buttons"></div>
    <div class="comment searchable">
      <p>
To reproduce, I got back to a 5.5 state:<br />
</p>
<ol><li><code>svn sw ^/branches/5.5</code>
</li><li>manually deleted transients in <code>wp_{main site id}_options</code>
</li><li>loaded main site dashboard
</li><li>checked database, saw that transient had <code>size</code> subarray
</li></ol><p>
...then tried to upgrade again:<br />
</p>
<ol><li><code>svn sw ^/branches/5.6</code>
</li><li>loaded main site dashboard, saw fatal in the widget
</li></ol>
    </div>

              </div>
              <div class="change" id="trac-change-3-1606921370907827">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:3" class="cnum">
    <a href="#comment:3">#3</a>
  </span>
    </span>
        <span class="avatar">
          <span class="username-line"><a href="https://profiles.wordpress.org/iandunn" class="profile-link">
            <img src="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=96 2x" height="48" width="48" /> @<span class="username" data-username="iandunn" data-nicename="iandunn"><span class="trac-author">iandunn</span></span></a></span>
            <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-02T15%3A02%3A50Z&amp;precision=second" title="See timeline at 12/02/2020 03:02:50 PM">2 days</a> ago</span>
        </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>
  <div class="trac-ticket-buttons"></div>
    <div class="comment searchable">
      <p>
In the public plugin repo, there are some plugins accessing the transient directly:<br />
</p>
<p>
<a class="ext-link" href="https://wpdirectory.net/search/01ERHZ02VEQ161CMAR4JHVZXCQ"><span class="icon">​</span>https://wpdirectory.net/search/01ERHZ02VEQ161CMAR4JHVZXCQ</a><br />
</p>
<p>
...but most are just deleting it.<br />
</p>
<p>
These 3 seem to have copied older versions of <code>get_dirsize()</code> and <code>recurse_dirsize()</code> into their codebase directly:<br />
</p>
<ul><li>PT Addons for Elementor Lite - 4k installs
</li><li>MediaPress - 3k installs
</li><li>Trustalyze Verified WooCommerce Reviews Extension - 10 installs
</li></ul><p>
It looks like they could set the transient w/ the old structure, and then that'd cause a fatal when Core tries to access it.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-4-1606923184972212">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:4" class="cnum">
    <a href="#comment:4">#4</a>
  </span>
    </span>
        <span class="avatar">
          <span class="username-line"><a href="https://profiles.wordpress.org/iandunn" class="profile-link">
            <img src="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=96 2x" height="48" width="48" /> @<span class="username" data-username="iandunn" data-nicename="iandunn"><span class="trac-author">iandunn</span></span></a></span>
            <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-02T15%3A33%3A04Z&amp;precision=second" title="See timeline at 12/02/2020 03:33:04 PM">2 days</a> ago</span>
        </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>
  <div class="trac-ticket-buttons"></div>
  <ul class="changes">
    <li class="trac-field-keywords">
      <strong class="trac-field-keywords">Keywords</strong>
        <em>needs-testing</em> removed
    </li>
  </ul>
    <div class="comment searchable">
      <p>
CC'ing the authors of those plugins: @sbrajesh, @rebusify, @paramthemes<br />
</p>
<p>
Your users may experience a fatal error on WP 5.6, please read the ticket above for details. <br />
</p>
<p>
The ideal solution for you might be to <code>include wp-includes/functions.php</code>, rather than copy/pasting those functions into your plugin code. I've only glanced at your code, though, so that might not work in your specific case. If those files aren't running in a WP context, you could use the REST API to access the data instead.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-5-1606923484939488">
                
  <h3 class="change chat-bot">
    <span class="avatar">
      <span class="username-line">
        <img src="https://wordpress.org/grav-redirect.php?user=slackbot&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=slackbot&amp;s=96 2x" height="48" width="48" />
        <p>
<em>This ticket was mentioned in <a class="ext-link" href="https://make.wordpress.org/chat/"><span class="icon">​</span>Slack</a> in #core by hellofromtonya. <a class="ext-link" href="https://wordpress.slack.com/archives/core/p1606923481099300"><span class="icon">​</span>View the logs</a>.</em><br />
</p>
      </span>
      <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-02T15%3A38%3A04Z&amp;precision=second" title="See timeline at 12/02/2020 03:38:04 PM">2 days</a> ago</span>
    </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>

              </div>
              <div class="change" id="trac-change-6-1606925180665228">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:6" class="cnum">
    <a href="#comment:6">#6</a>
  </span>
    </span>
        <span class="avatar">
          <span class="username-line"><a href="https://profiles.wordpress.org/janthiel" class="profile-link">
            <img src="https://wordpress.org/grav-redirect.php?user=janthiel&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=janthiel&amp;s=96 2x" height="48" width="48" /> @<span class="username" data-username="janthiel" data-nicename="janthiel"><span class="trac-author">janthiel</span></span></a></span>
            <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-02T16%3A06%3A20Z&amp;precision=second" title="See timeline at 12/02/2020 04:06:20 PM">2 days</a> ago</span>
        </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>
  <div class="trac-ticket-buttons"></div>
    <div class="comment searchable">
      <p>
@iandunn The only line of code that I can think of which could trigger the mentioned behaviour should be this:<br />
</p>
<p>
<a href="https://core.trac.wordpress.org/browser/branches/5.6/src/wp-includes/functions.php?rev=49643&amp;marks=7639#L7639">https://core.trac.wordpress.org/browser/branches/5.6/src/wp-includes/functions.php?rev=49643&amp;marks=7639#L7639</a><br />
</p>
<p>
This is the only direct return of an existing transient value. For the main site or root path of a site it might actually resolve and return the previously stored array when an INT is expected <br />
</p>
<pre class="wiki">['size' =&gt; 12345]
</pre><p>
Each other case should return "fresh" or no values due to the new way how the cache paths are actually stored per month.<br />
</p>
<p>
Resetting the transient will not help, if there are plugins using own code to write it. So I would suggest adding a check in the aforementioned line to see whether the return is an actual int before returning early? That should catch backward-compat and plugin issues.<br />
</p>
<p>
What do you think?<br />
</p>

    </div>
  <div class="trac-lastedit ">
    Last edited <a class="timeline" href="/timeline?from=2020-12-02T16%3A15%3A21Z&amp;precision=second" title="See timeline at 12/02/2020 04:15:21 PM">2 days ago</a>
        by <span class="trac-author">janthiel</span>
      (<a href="/ticket/51913?cversion=1&amp;cnum_hist=6#comment:6">previous</a>)
      (<a href="/ticket/51913?action=comment-diff&amp;cnum=6&amp;version=2">diff</a>)
  </div>

              </div>
              <div class="change" id="trac-change-7-1606926766656094">
                
  <h3 class="change chat-bot prbot with-context">
    <span class="avatar">
      <span class="username-line">
        <img src="https://wordpress.org/grav-redirect.php?user=prbot&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=prbot&amp;s=96 2x" height="48" width="48" />
        <p>
<em>This ticket was mentioned in <a class="ext-link" href="https://github.com/WordPress/wordpress-develop/pull/783"><span class="icon">​</span>PR #783</a> on <a class="ext-link" href="https://github.com/WordPress/wordpress-develop/"><span class="icon">​</span>WordPress/wordpress-develop</a> by <a class="ext-link" href="https://github.com/iandunn"><span class="icon">​</span>iandunn</a>.</em><br />
</p>
      </span>
      <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-02T16%3A32%3A46Z&amp;precision=second" title="See timeline at 12/02/2020 04:32:46 PM">2 days</a> ago</span>
    </span>
  </h3>
  <ul class="changes">
    <li class="trac-field-keywords">
      <strong class="trac-field-keywords">Keywords</strong>
        <em>has-patch</em> added
    </li>
  </ul>
  <div class="comment searchable">
    <p>
checks to make sure the transient value being returned is actually an int. it was an array in 5.5, but should be an int in 5.6. need to handle case where old 5.5 transient is present during upgrade to 5.6<br />
</p>
<p>
see <a href="https://core.trac.wordpress.org/ticket/51913#comment:6">https://core.trac.wordpress.org/ticket/51913#comment:6</a><br />
</p>
<p>
Trac ticket: <a href="https://core.trac.wordpress.org/ticket/51913">https://core.trac.wordpress.org/ticket/51913</a><br />
</p>

  </div>

              </div>
              <div class="change" id="trac-change-8-1606927400695893">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:8" class="cnum">
    <a href="#comment:8">#8</a>
  </span>
    </span>
        <span class="avatar">
          <span class="username-line"><a href="https://profiles.wordpress.org/iandunn" class="profile-link">
            <img src="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=96 2x" height="48" width="48" /> @<span class="username" data-username="iandunn" data-nicename="iandunn"><span class="trac-author">iandunn</span></span></a></span>
            <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-02T16%3A43%3A20Z&amp;precision=second" title="See timeline at 12/02/2020 04:43:20 PM">2 days</a> ago</span>
        </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>
  <div class="trac-ticket-buttons"></div>
    <div class="comment searchable">
      <p>
Yeah, that seems to be working so far, thanks!<br />
</p>
<p>
I'll work on some unit tests.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-9-1606934812655103">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:9" class="cnum">
    <a href="#comment:9">#9</a>
  </span>
    </span>
        <span class="avatar">
          <span class="username-line"><a href="https://profiles.wordpress.org/iandunn" class="profile-link">
            <img src="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=96 2x" height="48" width="48" /> @<span class="username" data-username="iandunn" data-nicename="iandunn"><span class="trac-author">iandunn</span></span></a></span>
            <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-02T18%3A46%3A52Z&amp;precision=second" title="See timeline at 12/02/2020 06:46:52 PM">2 days</a> ago</span>
        </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>
  <div class="trac-ticket-buttons"></div>
    <div class="comment searchable">
      <p>
Another condition that might be required to reproduce this is to have WP installed in a subdirectory, with a custom content directory a level above it. e.g.,<br />
</p>
<pre class="wiki">wp installed at: /home/foo/wordpress
content dir at:  /home/foo/wp-content
</pre><p>
...and nginx config like:<br />
</p>
<pre class="wiki">server {
	root /home/foo/wordpress;

	location /wp-content/ {
		root /home/foo;
	}
}
</pre><p>
...and a <code>wp-config</code> like:<br />
</p>
<pre class="wiki">define( 'ABSPATH',        '/home/foo/wordpress'  );
define( 'WP_CONTENT_DIR', '/home/foo/wp-content' );
</pre><p>
In a setup like that, <code>$cache_path</code> will be equal to <code>$directory</code>, because <code>ABSPATH</code> isn't stripped out.<br />
</p>
<p>
Making sure the return value is an <code>int</code> might still be worth it, but the underlying cause seems to be that the code makes assumptions about how things are setup. That could cause other problems if we don't make it more robust.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-10-1606939648866705">
                
  <h3 class="change chat-bot">
    <span class="avatar">
      <span class="username-line">
        <img src="https://wordpress.org/grav-redirect.php?user=slackbot&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=slackbot&amp;s=96 2x" height="48" width="48" />
        <p>
<em>This ticket was mentioned in <a class="ext-link" href="https://make.wordpress.org/chat/"><span class="icon">​</span>Slack</a> in #core by helen. <a class="ext-link" href="https://wordpress.slack.com/archives/core/p1606939646124700"><span class="icon">​</span>View the logs</a>.</em><br />
</p>
      </span>
      <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-02T20%3A07%3A28Z&amp;precision=second" title="See timeline at 12/02/2020 08:07:28 PM">2 days</a> ago</span>
    </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>

              </div>
              <div class="change" id="trac-change-11-1606943275055711">
                
  <h3 class="change chat-bot">
    <span class="avatar">
      <span class="username-line">
        <img src="https://wordpress.org/grav-redirect.php?user=slackbot&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=slackbot&amp;s=96 2x" height="48" width="48" />
        <p>
<em>This ticket was mentioned in <a class="ext-link" href="https://make.wordpress.org/chat/"><span class="icon">​</span>Slack</a> in #core-multisite by francina. <a class="ext-link" href="https://wordpress.slack.com/archives/core-multisite/p1606943255057300"><span class="icon">​</span>View the logs</a>.</em><br />
</p>
      </span>
      <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-02T21%3A07%3A55Z&amp;precision=second" title="See timeline at 12/02/2020 09:07:55 PM">2 days</a> ago</span>
    </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>

              </div>
              <div class="change" id="trac-change-12-1606951574817510">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:12" class="cnum">
    <a href="#comment:12">#12</a>
  </span>
    </span>
        <span class="avatar">
          <span class="username-line"><a href="https://profiles.wordpress.org/sbrajesh" class="profile-link">
            <img src="https://wordpress.org/grav-redirect.php?user=sbrajesh&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=sbrajesh&amp;s=96 2x" height="48" width="48" /> @<span class="username" data-username="sbrajesh" data-nicename="sbrajesh"><span class="trac-author">sbrajesh</span></span></a></span>
            <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-02T23%3A26%3A14Z&amp;precision=second" title="See timeline at 12/02/2020 11:26:14 PM">45 hours</a> ago</span>
        </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>
  <div class="trac-ticket-buttons"></div>
    <div class="comment searchable">
      <p>
Thank you @iandunn for notifying and suggesting the solution. Sincerely appreciate it.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-13-1606959071053988">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:13" class="cnum">
    <a href="#comment:13">#13</a>
  </span>
    </span>
        <span class="avatar">
          <span class="username-line"><a href="https://profiles.wordpress.org/iandunn" class="profile-link">
            <img src="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=96 2x" height="48" width="48" /> @<span class="username" data-username="iandunn" data-nicename="iandunn"><span class="trac-author">iandunn</span></span></a></span>
            <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-03T01%3A31%3A11Z&amp;precision=second" title="See timeline at 12/03/2020 01:31:11 AM">43 hours</a> ago</span>
        </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>
  <div class="trac-ticket-buttons"></div>
    <div class="comment searchable">
      <p>
Status update:<br />
</p>
<p>
Both the <code>is_int()</code> and the <code>WP_CONTENT_DIR</code> fixes seem to fix the problem on their own, but I'd recommend keeping both for safety.<br />
</p>
<p>
I'm not done w/ the unit tests yet, but have manually tested in a couple different kinds of setups, and don't expect to discover any problems. If the <code>WP_CONTENT_DIR</code> switch looks good to @janthiel, then I think we're probably in good shape.<br />
</p>
<p>
My only reservations are the short time period between RC3 and release, and the variety of setups in the wild. So, getting more eyes and testers would help a lot, especially if folks have dev/staging environments for real multisites that they could run RC2+this on. <br />
</p>
<p>
cc @peterwilsoncc, @dd32, @flixos90, @johnjamesjacoby <br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-14-1606980688774925">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:14" class="cnum">
    <a href="#comment:14">#14</a>
  </span>
    </span>
        <span class="avatar">
          <span class="username-line"><a href="https://profiles.wordpress.org/janthiel" class="profile-link">
            <img src="https://wordpress.org/grav-redirect.php?user=janthiel&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=janthiel&amp;s=96 2x" height="48" width="48" /> @<span class="username" data-username="janthiel" data-nicename="janthiel"><span class="trac-author">janthiel</span></span></a></span>
            <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-03T07%3A31%3A28Z&amp;precision=second" title="See timeline at 12/03/2020 07:31:28 AM">37 hours</a> ago</span>
        </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>
  <div class="trac-ticket-buttons"></div>
    <div class="comment searchable">
      <p>
@iandunn Thanks for the amazing job and jumping in :-)<br />
I agree that using <code>WP_CONTENT_DIR</code> seems more reliable than <code>ABSPATH</code> so I fully agree with that change.<br />
I would also vote to leave in the <code>is_int</code> check for reliability reasons and to avoid type mismatches in the return. That should fix the possible FATAL.<br />
</p>
<p>
The <code>str_replace</code> part using <code>WP_CONTENT_DIR</code> is meant for normalization and removal of path fragments that might change on hosting level (like moving web root or such). So WordPress should only store information relative to WordPress paths and independent of the server.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-15-1607013392548547">
                
  <h3 class="change chat-bot">
    <span class="avatar">
      <span class="username-line">
        <img src="https://wordpress.org/grav-redirect.php?user=slackbot&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=slackbot&amp;s=96 2x" height="48" width="48" />
        <p>
<em>This ticket was mentioned in <a class="ext-link" href="https://make.wordpress.org/chat/"><span class="icon">​</span>Slack</a> in #core by iandunn. <a class="ext-link" href="https://wordpress.slack.com/archives/core/p1607013388314600"><span class="icon">​</span>View the logs</a>.</em><br />
</p>
      </span>
      <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-03T16%3A36%3A32Z&amp;precision=second" title="See timeline at 12/03/2020 04:36:32 PM">27 hours</a> ago</span>
    </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>

              </div>
              <div class="change" id="trac-change-16-1607014368654603">
                
  <h3 class="change chat-bot">
    <span class="avatar">
      <span class="username-line">
        <img src="https://wordpress.org/grav-redirect.php?user=slackbot&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=slackbot&amp;s=96 2x" height="48" width="48" />
        <p>
<em>This ticket was mentioned in <a class="ext-link" href="https://make.wordpress.org/chat/"><span class="icon">​</span>Slack</a> in #core-multisite by hellofromtonya. <a class="ext-link" href="https://wordpress.slack.com/archives/core-multisite/p1607014366061900"><span class="icon">​</span>View the logs</a>.</em><br />
</p>
      </span>
      <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-03T16%3A52%3A48Z&amp;precision=second" title="See timeline at 12/03/2020 04:52:48 PM">27 hours</a> ago</span>
    </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>

              </div>
              <div class="change" id="trac-change-17-1607017079070863">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:17" class="cnum">
    <a href="#comment:17">#17</a>
  </span>
    </span>
        <span class="avatar">
          <span class="username-line"><a href="https://profiles.wordpress.org/iandunn" class="profile-link">
            <img src="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=96 2x" height="48" width="48" /> @<span class="username" data-username="iandunn" data-nicename="iandunn"><span class="trac-author">iandunn</span></span></a></span>
            <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-03T17%3A37%3A59Z&amp;precision=second" title="See timeline at 12/03/2020 05:37:59 PM">26 hours</a> ago</span>
        </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>
  <div class="trac-ticket-buttons"></div>
  <ul class="changes">
    <li class="trac-field-keywords">
      <strong class="trac-field-keywords">Keywords</strong>
        <em>needs-testing</em> added
    </li><li class="trac-field-version">
      <strong class="trac-field-version">Version</strong>
        set to <em>trunk</em>
    </li>
  </ul>
    <div class="comment searchable">
      <p>
I think the PR is settled and ready for testing. <br />
</p>
<p>
Reproducing is a bit of work, since there are some specific preconditions:<br />
</p>
<ul><li>PHP 8
</li><li>multisite
</li><li>custom <code>WP_CONTENT_DIR</code> that's not a child of WP's <code>ABSPATH</code> folder (e.g., like <a class="ext-link" href="https://roots.io/bedrock/"><span class="icon">​</span>Bedrock</a>)
</li><li><code>upload_space_check_disabled</code> option = <code>0</code>
</li></ul><p>
Steps:<br />
</p>
<ul><li>install latest 5.5
</li><li>delete the <code>dirsize_cache</code> transient
</li><li>visit <code>wp-admin/index.php</code>. it should work fine, and the transient should be populated. 
</li><li>upgrade to 5.6-RC2. if you now visit <code>wp-admin/index.php</code> you should see a fatal error inside the At A Glance widget
</li><li>if you then apply <a class="ext-link" href="https://github.com/WordPress/wordpress-develop/pull/783.diff"><span class="icon">​</span>https://github.com/WordPress/wordpress-develop/pull/783.diff</a> and refresh, the fatal should go away, and you should see the correct size calculation in that widget.
</li></ul><p>
testing the PR under PHP 7 + single site is helpful too, to make sure it doesn't have any unintended side-effects<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-18-1607024773623758">
                
  <h3 class="change chat-bot">
    <span class="avatar">
      <span class="username-line">
        <img src="https://wordpress.org/grav-redirect.php?user=slackbot&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=slackbot&amp;s=96 2x" height="48" width="48" />
        <p>
<em>This ticket was mentioned in <a class="ext-link" href="https://make.wordpress.org/chat/"><span class="icon">​</span>Slack</a> in #core by iandunn. <a class="ext-link" href="https://wordpress.slack.com/archives/core/p1607024768329600"><span class="icon">​</span>View the logs</a>.</em><br />
</p>
      </span>
      <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-03T19%3A46%3A13Z&amp;precision=second" title="See timeline at 12/03/2020 07:46:13 PM">24 hours</a> ago</span>
    </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>

              </div>
              <div class="change" id="trac-change-19-1607027864984749">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:19" class="cnum">
    <a href="#comment:19">#19</a>
  </span>
    </span>
        <span class="avatar">
          <span class="username-line"><a href="https://profiles.wordpress.org/iandunn" class="profile-link">
            <img src="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=96 2x" height="48" width="48" /> @<span class="username" data-username="iandunn" data-nicename="iandunn"><span class="trac-author">iandunn</span></span></a></span>
            <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-03T20%3A37%3A44Z&amp;precision=second" title="See timeline at 12/03/2020 08:37:44 PM">23 hours</a> ago</span>
        </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>
  <div class="trac-ticket-buttons"></div>
  <ul class="changes">
    <li class="trac-field-resolution">
      <strong class="trac-field-resolution">Resolution</strong>
        set to <em>fixed</em>
    </li><li class="trac-field-status">
      <strong class="trac-field-status">Status</strong>
        changed from <em>accepted</em> to <em>closed</em>
    </li>
  </ul>
    <div class="comment searchable">
      <p>
In <a class="changeset" href="/changeset/49744" title="Multisite: Cache absolute `dirsize` paths to avoid PHP 8 fatal.
 ...">49744</a>:<br />
</p>
<div class="message"><p>
Multisite: Cache absolute <code>dirsize</code> paths to avoid PHP 8 fatal.<br />
</p>
<p>
<a class="changeset" href="/changeset/49212" title="Multisite: More specific caching for `get_dirsize`.

Instead of one ...">r49212</a> greatly improved the performance of <code>get_dirsize()</code>, but also changed the structure of the data stored in the <code>dirsize_cache</code> transient. It stored relative paths instead of absolute ones, and also removed the unnecessary <code>size</code> array.<br />
</p>
<p>
That difference in data structures led to a fatal error in the following environment:<br />
</p>
<ul><li>PHP 8
</li><li>Multisite
</li><li>A custom <code>WP_CONTENT_DIR</code> which is not a child of WP's <code>ABSPATH</code> folder (e.g., <a class="ext-link" href="https://roots.io/bedrock/"><span class="icon">​</span>Bedrock</a>)
</li><li>The <code>upload_space_check_disabled</code> option set to <code>0</code>
</li></ul><p>
After upgrading to WP 5.6, the <code>dirsize_cache</code> transient still had data in the old format. When <code>wp-admin.php/index.php</code> was visited, <code>get_space_used()</code> received an <code>array</code> instead of an <code>int</code>, and tried to divide it by another <code>int</code>. PHP 7 would silently cast the arguments to match data types, but <a class="ext-link" href="https://wiki.php.net/rfc/arithmetic_operator_type_checks"><span class="icon">​</span>PHP 8 throws a fatal error</a>: <br />
</p>
<p>
<code>Uncaught TypeError: Unsupported operand types: array / int</code><br />
</p>
<p>
<code>recurse_dirsize()</code> was using <code>ABSPATH</code> to convert the absolute paths to relative ones, but some upload locations are not located under <code>ABSPATH</code>. In those cases, <code>$directory</code> and <code>$cache_path</code> were identical, and that triggered the early return of the old <code>array</code>, instead of the expected <code>int</code>. <br />
</p>
<p>
In order to avoid that, this commit restores the absolute paths, but without the <code>size</code> array. It also adds a type check when returning cached values. Using absolute paths without <code>size</code> has the result of overwriting the old data, so that it matches the new format. The type check and upgrade routine are additional safety measures.<br />
</p>
<p>
Props peterwilsoncc, janthiel, helen, hellofromtonya, francina, pbiron.<br />
Fixes <a class="closed ticket" href="/ticket/51913" title="#51913: defect (bug): Potential `unsupported operand types` dashboard fatal on PHP8 + ... (closed: fixed)">#51913</a>. See <a class="closed ticket" href="/ticket/19879" title="#19879: task (blessed): Better caching for get_dirsize (closed: fixed)">#19879</a>.<br />
</p>
</div>
    </div>

              </div>
              <div class="change" id="trac-change-20-1607028236659899">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:20" class="cnum">
    <a href="#comment:20">#20</a>
  </span>
    </span>
        <span class="avatar">
          <span class="username-line"><a href="https://profiles.wordpress.org/iandunn" class="profile-link">
            <img src="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=iandunn&amp;s=96 2x" height="48" width="48" /> @<span class="username" data-username="iandunn" data-nicename="iandunn"><span class="trac-author">iandunn</span></span></a></span>
            <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-03T20%3A43%3A56Z&amp;precision=second" title="See timeline at 12/03/2020 08:43:56 PM">23 hours</a> ago</span>
        </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>
  <div class="trac-ticket-buttons"></div>
    <div class="comment searchable">
      <p>
In <a class="changeset" href="/changeset/49745" title="Multisite: Cache absolute `dirsize` paths to avoid PHP 8 fatal.
 ...">49745</a>:<br />
</p>
<div class="message"><p>
Multisite: Cache absolute <code>dirsize</code> paths to avoid PHP 8 fatal.<br />
</p>
<p>
<a class="changeset" href="/changeset/49212" title="Multisite: More specific caching for `get_dirsize`.

Instead of one ...">r49212</a> greatly improved the performance of <code>get_dirsize()</code>, but also changed the structure of the data stored in the <code>dirsize_cache</code> transient. It stored relative paths instead of absolute ones, and also removed the unnecessary <code>size</code> array.<br />
</p>
<p>
That difference in data structures led to a fatal error in the following environment:<br />
</p>
<ul><li>PHP 8
</li><li>Multisite
</li><li>A custom <code>WP_CONTENT_DIR</code> which is not a child of WP's <code>ABSPATH</code> folder (e.g., <a class="ext-link" href="https://roots.io/bedrock/"><span class="icon">​</span>Bedrock</a>)
</li><li>The <code>upload_space_check_disabled</code> option set to <code>0</code>
</li></ul><p>
After upgrading to WP 5.6, the <code>dirsize_cache</code> transient still had data in the old format. When <code>wp-admin.php/index.php</code> was visited, <code>get_space_used()</code> received an <code>array</code> instead of an <code>int</code>, and tried to divide it by another <code>int</code>. PHP 7 would silently cast the arguments to match data types, but <a class="ext-link" href="https://wiki.php.net/rfc/arithmetic_operator_type_checks"><span class="icon">​</span>PHP 8 throws a fatal error</a>: <br />
</p>
<p>
<code>Uncaught TypeError: Unsupported operand types: array / int</code><br />
</p>
<p>
<code>recurse_dirsize()</code> was using <code>ABSPATH</code> to convert the absolute paths to relative ones, but some upload locations are not located under <code>ABSPATH</code>. In those cases, <code>$directory</code> and <code>$cache_path</code> were identical, and that triggered the early return of the old <code>array</code>, instead of the expected <code>int</code>. <br />
</p>
<p>
In order to avoid that, this commit restores the absolute paths, but without the <code>size</code> array. It also adds a type check when returning cached values. Using absolute paths without <code>size</code> has the result of overwriting the old data, so that it matches the new format. The type check and upgrade routine are additional safety measures.<br />
</p>
<p>
Props peterwilsoncc, janthiel, helen, hellofromtonya, francina, pbiron.<br />
Reviewed by SergeyBiryukov, iandunn.<br />
Merges <a class="changeset" href="/changeset/49744" title="Multisite: Cache absolute `dirsize` paths to avoid PHP 8 fatal.
 ...">[49744]</a> to the 5.6 branch.<br />
Fixes <a class="closed ticket" href="/ticket/51913" title="#51913: defect (bug): Potential `unsupported operand types` dashboard fatal on PHP8 + ... (closed: fixed)">#51913</a>. See <a class="closed ticket" href="/ticket/19879" title="#19879: task (blessed): Better caching for get_dirsize (closed: fixed)">#19879</a>.<br />
</p>
</div>
    </div>

              </div>
              <div class="change" id="trac-change-21-1607028697717741">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:21" class="cnum">
    <a href="#comment:21">#21</a>
  </span>
    </span>
        <span class="avatar">
          <span class="username-line"><a href="https://profiles.wordpress.org/prbot" class="profile-link">
            <img src="https://wordpress.org/grav-redirect.php?user=prbot&amp;s=48" srcset="https://wordpress.org/grav-redirect.php?user=prbot&amp;s=96 2x" height="48" width="48" /> @<span class="username" data-username="prbot" data-nicename="prbot"><span class="trac-author">prbot</span></span></a></span>
            <br /><span class="time-ago"><a class="timeline" href="/timeline?from=2020-12-03T20%3A51%3A37Z&amp;precision=second" title="See timeline at 12/03/2020 08:51:37 PM">23 hours</a> ago</span>
        </span>
    <div class="trac-ticket-buttons">
    </div>
  </h3>
  <div class="trac-ticket-buttons"></div>
    <div class="comment searchable">
      <p>
<a class="ext-link" href="https://github.com/iandunn"><span class="icon">​</span>iandunn</a> commented on <a class="ext-link" href="https://github.com/WordPress/wordpress-develop/pull/783#issuecomment-738299663"><span class="icon">​</span>PR #783</a>:<br />
</p>
<p>
merged in <a href="https://core.trac.wordpress.org/changeset/49744/">https://core.trac.wordpress.org/changeset/49744/</a><br />
</p>
<p>
thanks everyone!<br />
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="/wiki/TracTickets">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
    <a class="preferences-link" href="/prefs">Trac UI Preferences</a>
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="/ticket/51913?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="/ticket/51913?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="/ticket/51913?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
</div>
    </div>
<div id="wporg-footer">
	<div class="wrapper">
		<ul>
			<li><a href="https://wordpress.org/about/" title="An introduction to the WordPress project">About</a></li>
			<li><a href="https://wordpress.org/news/" title="News and Updates">Blog</a></li>
			<li><a href="https://wordpress.org/hosting/" title="Recommended web hosting providers">Hosting</a></li>
			<li><a href="https://wordpressfoundation.org/donate/" title="Donate to the WordPress Foundation">Donate</a></li>
		</ul>
		<ul>
			<li><a href="https://wordpress.org/support/" title="Forums, documentation, and other resources">Support</a></li>
			<li><a href="https://developer.wordpress.org" title="Resources for WordPress developers">Developers</a></li>
			<li><a href="https://make.wordpress.org/" title="Give back to WordPress through code, support, translation and more">Get Involved</a></li>
		</ul>
		<ul>
			<li><a href="https://wordpress.org/showcase/" title="Some of the best WordPress sites on the Web">Showcase</a></li>
			<li><a href="https://wordpress.org/plugins/" title="Add extra functionality to WordPress">Plugins</a></li>
			<li><a href="https://wordpress.org/themes/" title="Make your WordPress pretty">Themes</a></li>
		</ul>
		<ul>
			<li><a href="https://central.wordcamp.org/" title="Find a WordPress event near you">WordCamp</a></li>
			<li><a href="https://wordpress.tv/" title="Videos, tutorials, and WordCamp sessions">WordPress.TV</a></li>
			<li><a href="https://buddypress.org/" title="A set of plugins to transform your WordPress into a social network">BuddyPress</a></li>
			<li><a href="https://bbpress.org/" title="Fast, slick forums built on WordPress">bbPress</a></li>
		</ul>
		<ul>
			<li><a href="https://wordpress.com/?ref=wporg-footer" title="Hassle-free WordPress hosting">WordPress.com</a></li>
			<li><a href="https://ma.tt/" title="Co-founder of WordPress, an example of what WordPress can do">Matt</a></li>
			<li><a href="https://wordpress.org/about/privacy/" title="WordPress.org Privacy Policy">Privacy</a></li>
			<li><a href="https://publiccode.eu/" target="_blank">Public Code</a></li>
		</ul>
		<ul>
			<li><span class="dashicons dashicons-twitter"></span><a href="https://twitter.com/WordPress" title="Follow @WordPress on Twitter">@WordPress</a></li>
			<li><span class="dashicons dashicons-facebook"></span><a href="https://www.facebook.com/WordPress/" title="Like WordPress on Facebook">WordPress</a></li>
		</ul>
	</div>
	<p class="cip cip-image">Code is Poetry</p>
</div>
	<script>
	var wpTracCurrentUser = "anonymous";
	</script>
	<script src="https://s.w.org/style/js/navigation.min.js?20190128"></script>
	<script src="https://s.w.org/style/trac/jquery.caret.min.js?ver=2015-02-01"></script>
	<script src="https://s.w.org/style/trac/jquery.atwho.min.js?ver=1.0.1"></script>
	<script src="https://s.w.org/style/trac/wp-trac.js?148"></script>
		<script>
		(function() {
			var settings = { endpoint: 'https://make.wordpress.org/core/', authenticated: 0 };
			settings.ticket = 51913;
			wpTrac.notifications.init(settings);
		})();
		</script>
<div id="report-popup"></div>
<script>
var wpTracContributorLabels = {
	matt:              'Project Lead',
	markjaquith:       'Lead Developer',
	nacin:             'Lead Developer',
	azaozz:            'Lead Developer',
	dd32:              'Lead Developer',
	helen:             'Lead Developer',
	aaroncampbell:     'Core Committer',
	adamsilverstein:   'Core Committer',
	aduth:             'Core Committer',
	afercia:           'Core Committer',
	allancole:         'Core Committer',
	antpb:             'Core Committer',
	atimmer:           'Core Committer',
	boonebgorges:      'Core Committer',
	desrosj:           'Core Committer',
	DrewAPicture:      'Core Committer',
	ellatrix:          'Core Committer',
	flixos90:          'Core Committer',
	gziolo:            'Core Committer',
	iandunn:           'Core Committer',
	jeremyfelt:        'Core Committer',
	joedolson:         'Core Committer',
	joemcgill:         'Core Committer',
	joen:              'Core Committer',
	johnbillion:       'Core Committer',
	johnjamesjacoby:   'Core Committer',
	jorbin:            'Core Committer',
	jorgefilipecosta:  'Core Committer',
	jrf:               'Core Committer',
	kadamwhite:        'Core Committer',
	karmatosed:        'Core Committer',
	matveb:            'Core Committer',
	mcsf:              'Core Committer',
	melchoyce:         'Core Committer',
	mikeschroder:      'Core Committer',
	noisysocks:        'Core Committer',
	obenland:          'Core Committer',
	ocean90:           'Core Committer',
	pento:             'Core Committer',
	peterwilsoncc:     'Core Committer',
	ryelle:            'Core Committer',
	swissspidy:        'Core Committer',
	SergeyBiryukov:    'Core Committer',
	talldanwp:         'Core Committer',
	tellyworth:        'Core Committer',
	TimothyBlynJacobs: 'Core Committer',
	westonruter:       'Core Committer',
	whyisjake:         'Core Committer',
	wonderboymusic:    'Core Committer',
	xknown:            'Core Committer',
	youknowriad:       'Core Committer',
	davidakennedy:     'Themes Committer',
	ianbelanger:       'Themes Committer',
	iandstewart:       'Themes Committer',
	lancewillett:      'Themes Committer',
	laurelfulford:     'Themes Committer',
	designsimply:      'Lead Tester',
	ryan:              'Lead Tester',
	westi:             'Lead Developer',
	allendav:          'Core Committer',
	bpayton:           'Core Committer',
	duck_:             'Core Committer',
	ericlewis:         'Core Committer',
	herregroen:        'Core Committer',
	iammattthomas:     'Core Committer',
	jnylen0:           'Core Committer',
	joehoyle:          'Core Committer',
	josephscott:       'Core Committer',
	koop:              'Core Committer',
	kovshenin:         'Core Committer',
	lonelyvegan:       'Core Committer',
	mattmiklic:        'Core Committer',
	mdawaffe:          'Core Committer',
	michaelarestad:    'Core Committer',
	nbachiyski:        'Core Committer',
	omarreiss:         'Core Committer',
	rachelbaker:       'Core Committer',
	rmccue:            'Core Committer'
};
var wpTracAutoCompleteUsers = {
	include: $.map( wpTracContributorLabels, function( v, k ) { return k } ),
	exclude: [
		'slackbot',
		'ircbot',
	]
};
</script>
</body>
</html>